{% extends "base.html" %}
{% block title %}æˆ‘çš„æ´»è·ƒåº¦{% endblock %}

{% block head %}
<style>
    .activity-dashboard {
        background:#667eea;
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .stat-card {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 25px;
        margin: 15px 0;
        border: 1px solid rgba(255,255,255,0.2);
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        /* transform: translateY(-5px); */
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    }
    
    .stat-number {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .stat-label {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        position: relative;
        height: 400px;
    }
    
    .activity-timeline {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .timeline-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-left: 3px solid #667eea;
        padding-left: 20px;
        margin: 10px 0;
        position: relative;
    }
    
    .timeline-item::before {
        content: '';
        width: 12px;
        height: 12px;
        background: #667eea;
        border-radius: 50%;
        position: absolute;
        left: -7.5px;
        top: 50%;
        transform: translateY(-50%);
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 40px;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 50px;
    }
    
    .activity-progress {
        margin: 20px 0;
    }
    
    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-weight: 600;
    }
    
    .progress {
        height: 8px;
        border-radius: 20px;
        background: rgba(255,255,255,0.2);
    }
    
    .progress-bar {
        border-radius: 20px;
        background: linear-gradient(45deg, #ffd700, #ffed4e);
    }
</style>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="page-header">
        <h1 class="page-title">ğŸ“Š æˆ‘çš„æ´»è·ƒåº¦</h1>
        <p class="text-muted">å®æ—¶ç»Ÿè®¡æ‚¨åœ¨å¹³å°ä¸Šçš„æ´»åŠ¨æ•°æ®</p>
    </div>

    <!-- ç”¨æˆ·æ¦‚è§ˆå¡ç‰‡ -->
    <div class="activity-dashboard">
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="stat-number" id="questionsCount">{{ activity.total_questions if activity else 0 }}</div>
                    <div class="stat-label">ğŸ“ æé—®æ€»æ•°</div>
                    <div class="activity-progress">
                        <div class="progress-label">
                            <span>æ´»è·ƒåº¦</span>
                            <span id="questionProgress">{{ ((activity.total_questions / 10) * 100) | round if activity and activity.total_questions < 10 else 100 }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ ((activity.total_questions / 10) * 100) if activity and activity.total_questions < 10 else 100 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="stat-number" id="answersCount">{{ activity.total_answers if activity else 0 }}</div>
                    <div class="stat-label">ğŸ’¬ å›ç­”æ€»æ•°</div>
                    <div class="activity-progress">
                        <div class="progress-label">
                            <span>æ´»è·ƒåº¦</span>
                            <span id="answerProgress">{{ ((activity.total_answers / 20) * 100) | round if activity and activity.total_answers < 20 else 100 }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ ((activity.total_answers / 20) * 100) if activity and activity.total_answers < 20 else 100 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="stat-number" id="totalActivity">{{ (activity.total_questions + activity.total_answers) if activity else 0 }}</div>
                    <div class="stat-label">ğŸ”¥ æ€»æ´»è·ƒåº¦</div>
                    <div class="activity-progress">
                        <div class="progress-label">
                            <span>ç­‰çº§</span>
                            <span id="levelText">
                                {% if activity %}
                                    {% set total = activity.total_questions + activity.total_answers %}
                                    {% if total >= 50 %}ä¸“å®¶{% elif total >= 20 %}é«˜çº§{% elif total >= 10 %}ä¸­çº§{% else %}æ–°æ‰‹{% endif %}
                                {% else %}æ–°æ‰‹{% endif %}
                            </span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ (((activity.total_questions + activity.total_answers) / 50) * 100) if activity and (activity.total_questions + activity.total_answers) < 50 else 100 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-3">
            <h4>ğŸ‘‹ {{ user.username }}</h4>
            <p>åŠ å…¥æ—¶é—´: {{ user.join_time.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</p>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h4 class="text-center mb-4">ğŸ“ˆ æ´»åŠ¨åˆ†å¸ƒ</h4>
                <canvas id="activityPieChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h4 class="text-center mb-4">ğŸ“Š æ´»è·ƒåº¦å¯¹æ¯”</h4>
                <canvas id="activityBarChart"></canvas>
            </div>
        </div>
    </div>

    <!-- è¶‹åŠ¿å›¾ -->
    <div class="chart-container">
        <h4 class="text-center mb-4">ğŸ“… æœˆåº¦æ´»åŠ¨è¶‹åŠ¿</h4>
        <canvas id="activityLineChart"></canvas>
    </div>

    <!-- æœ€è¿‘æ´»åŠ¨æ—¶é—´çº¿ -->
    <div class="activity-timeline">
        <h4 class="mb-4">ğŸ•’ æœ€è¿‘æ´»åŠ¨</h4>
        <div id="activityTimeline">
            {% if activity and (activity.total_questions > 0 or activity.total_answers > 0) %}
                <div class="timeline-item">
                    <div>
                        <strong>ğŸ‰ æ¬¢è¿æ¥åˆ°çŸ¥äº†é—®ç­”!</strong>
                        <small class="text-muted d-block">æ‚¨å·²ç»è´¡çŒ®äº† {{ activity.total_questions }} ä¸ªé—®é¢˜å’Œ {{ activity.total_answers }} ä¸ªå›ç­”</small>
                    </div>
                </div>
                {% if activity.total_questions > 0 %}
                <div class="timeline-item">
                    <div>
                        <strong>ğŸ“ å‘å¸ƒé—®é¢˜</strong>
                        <small class="text-muted d-block">æ€»å…±å‘å¸ƒäº† {{ activity.total_questions }} ä¸ªé—®é¢˜</small>
                    </div>
                </div>
                {% endif %}
                {% if activity.total_answers > 0 %}
                <div class="timeline-item">
                    <div>
                        <strong>ğŸ’¬ å›ç­”é—®é¢˜</strong>
                        <small class="text-muted d-block">æ€»å…±å›ç­”äº† {{ activity.total_answers }} ä¸ªé—®é¢˜</small>
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>è¿˜æ²¡æœ‰æ´»åŠ¨è®°å½•ï¼Œå¿«å»å‘å¸ƒç¬¬ä¸€ä¸ªé—®é¢˜å§ï¼</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="{{ url_for('qa.index') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
        </a>
        <a href="{{ url_for('qa.public_question') }}" class="btn btn-success btn-lg ml-2">
            <i class="fas fa-plus"></i> å‘å¸ƒé—®é¢˜
        </a>
    </div>
</div>

<!-- åŠ è½½æç¤º -->
<div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">åŠ è½½ä¸­...</span>
    </div>
    <p class="mt-2">æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...</p>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ•°æ®
    const questionsCount = {{ activity.total_questions if activity else 0 }};
    const answersCount = {{ activity.total_answers if activity else 0 }};
    const totalActivity = questionsCount + answersCount;

    // 1. é¥¼å›¾ - æ´»åŠ¨åˆ†å¸ƒ
    const pieCtx = document.getElementById('activityPieChart').getContext('2d');
    const pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: ['æé—®', 'å›ç­”'],
            datasets: [{
                data: [questionsCount, answersCount],
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(118, 75, 162, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(118, 75, 162, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = questionsCount + answersCount;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });

    // 2. æŸ±çŠ¶å›¾ - æ´»è·ƒåº¦å¯¹æ¯”
    const barCtx = document.getElementById('activityBarChart').getContext('2d');
    const barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['æˆ‘çš„æé—®', 'æˆ‘çš„å›ç­”', 'æ€»æ´»è·ƒåº¦'],
            datasets: [{
                label: 'æ•°é‡',
                data: [questionsCount, answersCount, totalActivity],
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(118, 75, 162, 0.8)',
                    'rgba(255, 215, 0, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(118, 75, 162, 1)',
                    'rgba(255, 215, 0, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // 3. æŠ˜çº¿å›¾ - æœˆåº¦è¶‹åŠ¿ (æ¨¡æ‹Ÿæ•°æ®)
    const lineCtx = document.getElementById('activityLineChart').getContext('2d');
    
    // ç”Ÿæˆæœ€è¿‘6ä¸ªæœˆçš„æ ‡ç­¾
    const months = [];
    const now = new Date();
    for(let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push(date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short' }));
    }

    // æ¨¡æ‹Ÿæœˆåº¦æ•°æ®åˆ†å¸ƒ
    const monthlyQuestions = [];
    const monthlyAnswers = [];
    
    for(let i = 0; i < 6; i++) {
        // å°†æ€»æ•°æ®åˆ†å¸ƒåˆ°6ä¸ªæœˆä¸­ï¼Œæœ€è¿‘æœˆä»½å æ¯”æ›´é«˜
        const questionRatio = [0.05, 0.1, 0.15, 0.2, 0.25, 0.25][i];
        const answerRatio = [0.08, 0.12, 0.18, 0.22, 0.2, 0.2][i];
        
        monthlyQuestions.push(Math.round(questionsCount * questionRatio));
        monthlyAnswers.push(Math.round(answersCount * answerRatio));
    }

    const lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'æé—®æ•°',
                data: monthlyQuestions,
                borderColor: 'rgba(102, 126, 234, 1)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'å›ç­”æ•°',
                data: monthlyAnswers,
                borderColor: 'rgba(118, 75, 162, 1)',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // æ•°å­—åŠ¨ç”»æ•ˆæœ
    function animateNumbers() {
        const numbers = document.querySelectorAll('.stat-number');
        numbers.forEach((number, index) => {
            const finalValue = parseInt(number.textContent);
            let currentValue = 0;
            const increment = finalValue / 50;
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= finalValue) {
                    number.textContent = finalValue;
                    clearInterval(timer);
                } else {
                    number.textContent = Math.floor(currentValue);
                }
            }, 30);
        });
    }

    // å¯åŠ¨æ•°å­—åŠ¨ç”»
    setTimeout(animateNumbers, 500);

    // æ·»åŠ å®æ—¶æ›´æ–°åŠŸèƒ½
    function updateRealTimeData() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ AJAXè¯·æ±‚æ¥è·å–æœ€æ–°æ•°æ®
        // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
        setTimeout(updateRealTimeData, 30000);
    }

    // å¯åŠ¨å®æ—¶æ›´æ–°
    updateRealTimeData();
});
</script>
{% endblock %}